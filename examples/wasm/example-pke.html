<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Public-Key Encryption (PKE) Demo - OpenABE WASM</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1000px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #9C27B0;
            padding-bottom: 10px;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .user-card {
            padding: 15px;
            background: #f3e5f5;
            border-radius: 4px;
            border: 2px solid #9C27B0;
        }
        .user-card h3 {
            margin-top: 0;
            color: #9C27B0;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 4px;
        }
        label {
            display: block;
            margin: 10px 0 5px;
            font-weight: bold;
            color: #555;
        }
        input, textarea, select {
            width: 100%;
            padding: 8px;
            margin: 5px 0 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #9C27B0;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        button:hover {
            background-color: #7B1FA2;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .output {
            background: #f0f0f0;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            word-break: break-all;
            min-height: 40px;
            font-size: 12px;
        }
        .success { color: #4CAF50; }
        .error { color: #f44336; }
        .info { color: #2196F3; }
        .note {
            background: #e3f2fd;
            padding: 15px;
            border-left: 4px solid #2196F3;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Public-Key Encryption (PKE) Demo</h1>

        <div class="note">
            <strong>About PKE:</strong> Traditional public-key encryption where Alice can encrypt to Bob's
            public key, and only Bob (with the private key) can decrypt. This demo uses elliptic curve
            cryptography (ECC) for efficient encryption.
        </div>

        <div class="section">
            <h2>1. Initialize</h2>
            <label>Elliptic Curve:</label>
            <select id="curveSelect">
                <option value="NIST_P256">NIST P-256 (secp256r1) - Recommended</option>
                <option value="NIST_P384">NIST P-384 (secp384r1)</option>
                <option value="NIST_P521">NIST P-521 (secp521r1)</option>
            </select>
            <button id="initBtn" onclick="initializePKE()">Initialize PKE</button>
            <p id="statusMsg" class="info">Select a curve and click "Initialize PKE"</p>
        </div>

        <div class="grid">
            <div class="user-card">
                <h3>üë§ Alice</h3>
                <button onclick="generateKeypair('alice')" disabled id="aliceGenBtn">Generate Keypair</button>
                <p id="aliceKeyStatus" class="output">No keypair generated</p>

                <h4>Export Keys</h4>
                <button onclick="exportKeys('alice')" disabled id="aliceExportBtn">Export Public Key</button>
                <div id="alicePubKey" class="output">Public key will appear here...</div>
            </div>

            <div class="user-card">
                <h3>üë§ Bob</h3>
                <button onclick="generateKeypair('bob')" disabled id="bobGenBtn">Generate Keypair</button>
                <p id="bobKeyStatus" class="output">No keypair generated</p>

                <h4>Export Keys</h4>
                <button onclick="exportKeys('bob')" disabled id="bobExportBtn">Export Public Key</button>
                <div id="bobPubKey" class="output">Public key will appear here...</div>
            </div>
        </div>

        <div class="section">
            <h2>2. Encrypt Message</h2>
            <label>Sender:</label>
            <select id="sender">
                <option value="alice">Alice</option>
                <option value="bob">Bob</option>
            </select>

            <label>Receiver:</label>
            <select id="receiver">
                <option value="bob">Bob</option>
                <option value="alice">Alice</option>
            </select>

            <label>Message:</label>
            <textarea id="plaintext" rows="3">Hello! This is a secret message encrypted with your public key.</textarea>

            <button onclick="encryptMessage()" disabled id="encryptBtn">Encrypt</button>

            <label>Ciphertext:</label>
            <div id="ciphertext" class="output">Ciphertext will appear here...</div>
        </div>

        <div class="section">
            <h2>3. Decrypt Message</h2>
            <label>Decryptor (must match receiver above):</label>
            <select id="decryptor">
                <option value="bob">Bob</option>
                <option value="alice">Alice</option>
            </select>

            <button onclick="decryptMessage()" disabled id="decryptBtn">Decrypt</button>

            <label>Decrypted Message:</label>
            <div id="decrypted" class="output">Decrypted message will appear here...</div>
        </div>

        <div class="section">
            <h2>4. Key Exchange</h2>
            <p class="info">In real applications, users exchange public keys and import them:</p>

            <label>Import Alice's public key to Bob's context:</label>
            <button onclick="importAliceKeyToBob()" disabled id="importAliceBtn">Import Alice's Key to Bob</button>

            <label>Import Bob's public key to Alice's context:</label>
            <button onclick="importBobKeyToAlice()" disabled id="importBobBtn">Import Bob's Key to Alice</button>

            <div id="importStatus" class="output">Import status will appear here...</div>
        </div>
    </div>

    <script src="openabe-wrapper.js"></script>
    <script>
        let wasmModule = null;
        let pkeContext = null;
        let currentCiphertext = null;
        let keys = {
            alice: { generated: false, publicKey: null },
            bob: { generated: false, publicKey: null }
        };

        async function initializePKE() {
            try {
                const curve = document.getElementById('curveSelect').value;
                document.getElementById('statusMsg').textContent = 'Loading WASM module...';

                const response = await fetch('openabe.wasm');
                const wasmBytes = await response.arrayBuffer();
                const wasmResult = await WebAssembly.instantiate(wasmBytes);

                wasmModule = wasmResult.instance.exports;
                initOpenABE(wasmModule);

                // Create PKE context with selected curve
                pkeContext = new OpenPKEContext(wasmModule, curve);

                document.getElementById('statusMsg').textContent =
                    `PKE initialized with ${curve}!`;
                document.getElementById('statusMsg').className = 'success';

                // Enable keypair generation
                document.getElementById('aliceGenBtn').disabled = false;
                document.getElementById('bobGenBtn').disabled = false;
                document.getElementById('initBtn').disabled = true;

            } catch (error) {
                document.getElementById('statusMsg').textContent = 'Error: ' + error.message;
                document.getElementById('statusMsg').className = 'error';
            }
        }

        function generateKeypair(user) {
            try {
                pkeContext.keygen(user);
                keys[user].generated = true;

                document.getElementById(user + 'KeyStatus').textContent =
                    `‚úì Keypair generated for ${user}`;
                document.getElementById(user + 'KeyStatus').className = 'output success';

                document.getElementById(user + 'ExportBtn').disabled = false;
                document.getElementById(user + 'GenBtn').disabled = true;

                // Enable encryption if both have keys
                if (keys.alice.generated && keys.bob.generated) {
                    document.getElementById('encryptBtn').disabled = false;
                }

            } catch (error) {
                document.getElementById(user + 'KeyStatus').textContent = 'Error: ' + error.message;
                document.getElementById(user + 'KeyStatus').className = 'output error';
            }
        }

        function exportKeys(user) {
            try {
                const pubKey = pkeContext.exportPublicKey(user);
                keys[user].publicKey = pubKey;

                const base64 = btoa(String.fromCharCode.apply(null, pubKey));
                document.getElementById(user + 'PubKey').textContent =
                    `Public Key (${pubKey.length} bytes):\n${base64.substring(0, 100)}...`;

                // Enable import buttons
                if (user === 'alice') {
                    document.getElementById('importAliceBtn').disabled = false;
                } else {
                    document.getElementById('importBobBtn').disabled = false;
                }

            } catch (error) {
                document.getElementById(user + 'PubKey').textContent = 'Error: ' + error.message;
            }
        }

        function encryptMessage() {
            try {
                const sender = document.getElementById('sender').value;
                const receiver = document.getElementById('receiver').value;
                const plaintext = document.getElementById('plaintext').value;

                if (!plaintext) {
                    alert('Please enter a message');
                    return;
                }

                // Encrypt to receiver's public key
                const ciphertext = pkeContext.encrypt(receiver, plaintext);
                currentCiphertext = ciphertext;

                const base64 = btoa(String.fromCharCode.apply(null, ciphertext));
                document.getElementById('ciphertext').textContent =
                    `Encrypted from ${sender} to ${receiver}\n` +
                    `Ciphertext (${ciphertext.length} bytes):\n${base64.substring(0, 150)}...`;

                // Enable decryption
                document.getElementById('decryptor').value = receiver;
                document.getElementById('decryptBtn').disabled = false;

            } catch (error) {
                document.getElementById('ciphertext').textContent = 'Error: ' + error.message;
            }
        }

        function decryptMessage() {
            try {
                const decryptor = document.getElementById('decryptor').value;

                if (!currentCiphertext) {
                    alert('Please encrypt a message first');
                    return;
                }

                const plaintext = pkeContext.decrypt(decryptor, currentCiphertext);

                if (plaintext === null) {
                    document.getElementById('decrypted').textContent =
                        '‚ùå Decryption failed: Wrong private key';
                    document.getElementById('decrypted').className = 'output error';
                } else {
                    const text = new TextDecoder().decode(plaintext);
                    document.getElementById('decrypted').textContent =
                        `‚úì Decrypted by ${decryptor}:\n\n${text}`;
                    document.getElementById('decrypted').className = 'output success';
                }

            } catch (error) {
                document.getElementById('decrypted').textContent = 'Error: ' + error.message;
                document.getElementById('decrypted').className = 'output error';
            }
        }

        function importAliceKeyToBob() {
            try {
                if (!keys.alice.publicKey) {
                    alert('Please export Alice\'s public key first');
                    return;
                }

                // In practice, Bob would receive this key and import it
                pkeContext.importPublicKey('alice', keys.alice.publicKey);

                document.getElementById('importStatus').textContent =
                    '‚úì Alice\'s public key imported to Bob\'s context\n' +
                    'Bob can now encrypt messages to Alice';
                document.getElementById('importStatus').className = 'output success';

            } catch (error) {
                document.getElementById('importStatus').textContent = 'Error: ' + error.message;
                document.getElementById('importStatus').className = 'output error';
            }
        }

        function importBobKeyToAlice() {
            try {
                if (!keys.bob.publicKey) {
                    alert('Please export Bob\'s public key first');
                    return;
                }

                pkeContext.importPublicKey('bob', keys.bob.publicKey);

                document.getElementById('importStatus').textContent =
                    '‚úì Bob\'s public key imported to Alice\'s context\n' +
                    'Alice can now encrypt messages to Bob';
                document.getElementById('importStatus').className = 'output success';

            } catch (error) {
                document.getElementById('importStatus').textContent = 'Error: ' + error.message;
                document.getElementById('importStatus').className = 'output error';
            }
        }

        window.addEventListener('beforeunload', () => {
            if (pkeContext) {
                pkeContext.destroy();
                shutdownOpenABE(wasmModule);
            }
        });
    </script>
</body>
</html>
